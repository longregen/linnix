version: '3.8'

services:
  # Linnix monitoring daemon
  cognitod:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: linnix-cognitod
    privileged: true
    pid: host
    network_mode: host
    volumes:
      - /sys/kernel/debug:/sys/kernel/debug:ro
      - /sys/fs/bpf:/sys/fs/bpf
      - ./demo-rules.yaml:/etc/linnix/rules.yaml:ro
    environment:
      - RUST_LOG=info
    command: /usr/local/bin/cognitod
    restart: unless-stopped

  # Scenario 1: Memory leak
  memory-leak:
    build:
      context: ./scenarios/memory-leak
    container_name: linnix-demo-memory-leak
    mem_limit: 200m
    mem_reservation: 50m
    profiles:
      - demo
    depends_on:
      - cognitod

  # Scenario 2: Fork bomb
  fork-bomb:
    build:
      context: ./scenarios/fork-bomb
    container_name: linnix-demo-fork-bomb
    pids_limit: 200
    profiles:
      - demo
    depends_on:
      - cognitod

  # Scenario 3: FD exhaustion
  fd-exhaustion:
    build:
      context: ./scenarios/fd-exhaustion
    container_name: linnix-demo-fd-exhaustion
    ulimits:
      nofile:
        soft: 256
        hard: 256
    profiles:
      - demo
    depends_on:
      - cognitod

  # CLI to stream alerts
  linnix-cli:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: linnix-cli
    network_mode: host
    command: /usr/local/bin/linnix-cli --url http://localhost:3000 --alerts --no-color
    profiles:
      - demo
    depends_on:
      - cognitod
